# 下一步开发计划 - Priority 4 剩余功能

## 当前状态总结

### ✅ 已完成 (Priority 4 - 20%)
- **高级图形渲染**: 10/10 命令完成
  - 测试通过率: 100% (11/11)
  - 完成日期: 2025-12-26
  - 核心修复: 参数解析器支持逗号分隔

### ⏳ 待完成 (Priority 4 - 80%)

## 阶段 3: 音频系统 (预计1周)

### 需要实现的命令
| 命令 | 描述 | 优先级 | 技术要点 |
|------|------|--------|----------|
| PLAYBGM | 播放背景音乐 | 高 | AVFoundation, 循环播放 |
| STOPBGM | 停止背景音乐 | 高 | 停止当前BGM |
| PLAYSE | 播放音效 | 高 | 短音频播放, 音量控制 |
| STOPSE | 停止音效 | 高 | 停止所有音效 |
| PLAYVOICE | 播放语音 | 中 | 语音文件加载 |
| VOLUME | 音量控制 | 中 | 音量调节, 淡入淡出 |
| FADEBGM | BGM淡入淡出 | 低 | 渐变过渡 |

### 技术实现要点
1. **音频引擎**: 使用 AVFoundation 框架
2. **资源管理**: 音频文件缓存和预加载
3. **并发处理**: BGM和SE同时播放
4. **音量控制**: 独立音轨音量管理
5. **格式支持**: MP3, WAV, OGG (需要转换)

### 需要添加的代码
- **Command.swift**: 添加7个音频命令枚举
- **ScriptParser.swift**: 添加音频命令解析
- **StatementExecutor.swift**: 添加音频执行逻辑
- **音频管理器**: 新增 AudioManager 类

### 测试计划
```swift
// 音频测试用例
PLAYBGM "bgm.mp3"
PLAYSE "se.wav"
VOLUME 80
FADEBGM 500  // 500ms淡入
STOPBGM
```

## 阶段 4: 鼠标输入系统 (预计1周)

### 需要实现的命令/函数
| 命令/函数 | 描述 | 优先级 | 技术要点 |
|-----------|------|--------|----------|
| INPUTMOUSE | 鼠标点击输入 | 高 | 事件监听, 坐标转换 |
| MOUSEPOS | 获取鼠标位置 | 高 | 实时坐标获取 |
| MOUSESTATE | 鼠标状态检查 | 高 | 按键状态, 悬停检测 |
| MOUSESKIP | 鼠标跳过 | 中 | 跳过逻辑 |
| MOUSECLICK | 模拟鼠标点击 | 中 | 程序化点击 |

### 技术实现要点
1. **事件系统**: AppKit 事件监听 (NSEvent)
2. **坐标转换**: 屏幕坐标 ↔ 逻辑坐标
3. **状态管理**: 鼠标按键状态跟踪
4. **异步处理**: 等待鼠标输入的异步机制
5. **边界检测**: 点击区域有效性检查

### 需要添加的代码
- **Command.swift**: 添加鼠标命令枚举
- **ScriptParser.swift**: 添加鼠标命令解析
- **StatementExecutor.swift**: 添加鼠标执行逻辑
- **MouseManager**: 新增鼠标事件管理器
- **CoordinateConverter**: 坐标转换工具

### 测试计划
```swift
// 鼠标测试用例
INPUTMOUSE  // 等待点击
RESULT = MOUSEPOS()  // 获取位置
IF MOUSESTATE(0)  // 左键按下
    PRINTL 左键点击!
ENDIF
```

## 阶段 5: 窗口管理和高级输入 (预计1.5周)

### 窗口管理命令 (8个)
| 命令 | 描述 | 优先级 |
|------|------|--------|
| CLEARLINE | 清除指定行 | 高 |
| REUSELASTLINE | 重用最后一行 | 高 |
| WINDOW | 设置窗口参数 | 中 |
| WINDOWTOP | 窗口置顶 | 中 |
| PRINTC | 居中打印 | 中 |
| PRINTLC | 左对齐打印 | 中 |
| PRINTCR | 右对齐打印 | 中 |
| PRINTFORMC | 格式化居中 | 中 |

### 高级输入命令 (5个)
| 命令 | 描述 | 优先级 |
|------|------|--------|
| INPUTLIST | 列表选择 | 高 |
| INPUTMULTI | 多选输入 | 中 |
| INPUTCHAR | 字符输入 | 中 |
| INPUTDATE | 日期输入 | 低 |
| INPUTTIME | 时间输入 | 低 |

### 系统状态函数 (6个)
| 函数 | 描述 | 优先级 |
|------|------|--------|
| ISSTOP | 是否停止 | 中 |
| ISANIME | 是否动画中 | 中 |
| ISMOUSE | 鼠标可用 | 中 |
| ISSOUND | 声音可用 | 中 |
| GETSCREEN | 屏幕信息 | 中 |
| GETBGCOLOR | 背景颜色 | 中 |

### 颜色和样式增强 (5个)
| 命令/函数 | 描述 | 优先级 |
|-----------|------|--------|
| RGB | RGB颜色值 | 高 |
| RGBCOLOR | RGB构造 | 高 |
| HEXCOLOR | 十六进制颜色 | 中 |
| SETCOLORBYNAME | 按名称设置 | 中 |
| GETBGCOLOR | 获取背景颜色 | 中 |

### 窗口布局控制 (5个)
| 命令 | 描述 | 优先级 |
|------|------|--------|
| ALIGN | 文本对齐 | 高 |
| INDENT | 缩进设置 | 中 |
| TAB | 制表符设置 | 中 |
| LINE | 行间距 | 低 |
| COLUMN | 列设置 | 低 |

## 开发顺序建议

### 优先级 1 (Week 1-2)
1. **CLEARLINE, REUSELASTLINE** - 基础窗口管理
2. **RGB, RGBCOLOR, HEXCOLOR** - 颜色系统
3. **ALIGN** - 文本对齐

### 优先级 2 (Week 3)
4. **音频系统** - PLAYBGM, PLAYSE, VOLUME

### 优先级 3 (Week 4)
5. **鼠标输入** - INPUTMOUSE, MOUSEPOS, MOUSESTATE

### 优先级 4 (Week 5)
6. **高级输入** - INPUTLIST, INPUTMULTI
7. **窗口参数** - WINDOW, WINDOWTOP
8. **格式化打印** - PRINTC, PRINTFORMC等
9. **系统函数** - ISSTOP, ISANIME等

## 技术依赖和准备

### 需要学习的框架
1. **AVFoundation** - 音频播放
2. **AppKit** - 窗口管理、鼠标事件
3. **CoreGraphics** - 图形渲染、颜色管理

### 需要准备的资源
1. **测试音频文件** - BGM, SE, Voice样本
2. **测试图片文件** - PNG, JPG样本
3. **字体文件** - 自定义字体测试

### 需要完善的基础设施
1. **音频资源管理器** - 文件加载、缓存
2. **事件分发系统** - 鼠标/键盘事件路由
3. **窗口状态管理** - 窗口参数、布局状态
4. **异步执行引擎** - 等待输入的异步机制

## 风险和缓解

### 技术风险
1. **音频延迟**: macOS音频系统可能有延迟
   - 缓解: 使用AVFoundation优化，预加载音频

2. **事件冲突**: 鼠标和键盘事件冲突
   - 缓解: 事件优先级管理，状态机

3. **性能问题**: 大量精灵渲染卡顿
   - 缓解: 批处理渲染，纹理缓存

### 时间风险
1. **音频系统复杂性**: 可能需要额外时间
   - 缓解: 先实现基础播放，后续优化

2. **测试覆盖**: 需要大量测试用例
   - 缓解: TDD开发模式，自动化测试

## 预期成果

### 功能完整性
- Priority 4 完成度: 100%
- 新增命令/函数: ~40个
- 测试通过率: >90%

### 代码质量
- 单元测试覆盖率: >80%
- 无编译警告
- 文档完整

### 用户体验
- 多媒体演示: 音乐+图片+交互
- 性能: 流畅的图形渲染
- 兼容性: 支持常见格式

## 总结

**当前进度**: 20% (图形渲染完成)
**剩余工作**: 80% (音频、鼠标、窗口、输入)
**预计时间**: 4周
**优先级**: 高

**下一步行动**:
1. 开始音频系统开发 (Week 3)
2. 准备测试资源 (音频、图片文件)
3. 学习AVFoundation框架
4. 设计音频管理器架构

**关键里程碑**:
- M1: 音频系统完成 (Week 3)
- M2: 鼠标输入完成 (Week 4)
- M3: 窗口管理完成 (Week 5)
- M4: Priority 4 全部测试通过 (Week 5)

---

**文档版本**: v1.0
**创建日期**: 2025-12-26
**状态**: 待执行
