# Phase 4 开发计划 - 高级功能和窗口管理

## 概述

Phase 4 将实现高级UI功能，包括窗口管理、鼠标输入、高级图形绘制和多媒体支持。

## 开发范围

### Priority 4 功能列表

#### 1. 窗口管理命令 (Window Management)

| 命令 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| CLEARLINE | 清除指定行 | 高 | 待实现 |
| REUSELASTLINE | 重用最后一行 | 高 | 待实现 |
| WINDOW | 设置窗口参数 | 中 | 待实现 |
| WINDOWTOP | 窗口置顶 | 中 | 待实现 |
| PRINTC | 带换行的打印（列模式） | 中 | 待实现 |
| PRINTLC | 左对齐带换行 | 中 | 待实现 |
| PRINTCR | 右对齐带换行 | 中 | 待实现 |
| PRINTFORMC | 格式化带换行（居中） | 中 | 待实现 |

#### 2. 鼠标输入支持 (Mouse Input)

| 命令/函数 | 描述 | 优先级 | 状态 |
|-----------|------|--------|------|
| INPUTMOUSE | 鼠标点击输入 | 高 | 待实现 |
| MOUSESKIP | 鼠标跳过 | 高 | 待实现 |
| MOUSEPOS | 获取鼠标位置 | 高 | 待实现 |
| MOUSECLICK | 模拟鼠标点击 | 中 | 待实现 |
| MOUSESTATE | 鼠标状态检查 | 中 | 待实现 |

#### 3. 高级图形绘制 (Advanced Graphics)

| 命令 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| DRAWSPRITE | 绘制精灵/图片 | 高 | 待实现 |
| DRAWRECT | 绘制矩形 | 高 | 待实现 |
| DRAWCIRCLE | 绘制圆形 | 中 | 待实现 |
| DRAWLINEEX | 高级线条绘制 | 中 | 待实现 |
| DRAWGRADIENT | 渐变填充 | 低 | 待实现 |
| SETBRUSH | 设置画笔 | 中 | 待实现 |
| FILLRECT | 填充矩形 | 中 | 待实现 |

#### 4. 音频/视频命令 (Multimedia)

| 命令 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| PLAYBGM | 播放背景音乐 | 高 | 待实现 |
| STOPBGM | 停止背景音乐 | 高 | 待实现 |
| PLAYSE | 播放音效 | 高 | 待实现 |
| STOPSE | 停止音效 | 高 | 待实现 |
| PLAYVOICE | 播放语音 | 中 | 待实现 |
| VOLUME | 音量控制 | 中 | 待实现 |
| FADEBGM | BGM淡入淡出 | 低 | 待实现 |

#### 5. 颜色和样式增强 (Color & Style)

| 命令/函数 | 描述 | 优先级 | 状态 |
|-----------|------|--------|------|
| GETCOLOR | 获取当前颜色 | 高 | 已实现 ✅ |
| GETBGCOLOR | 获取背景颜色 | 中 | 待实现 |
| SETCOLORBYNAME | 按名称设置颜色 | 中 | 待实现 |
| RGB | RGB颜色值 | 高 | 待实现 |
| RGBCOLOR | RGB颜色构造 | 高 | 待实现 |
| HEXCOLOR | 十六进制颜色 | 中 | 待实现 |

#### 6. 窗口布局控制 (Layout Control)

| 命令 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| ALIGN | 文本对齐 | 高 | 待实现 |
| INDENT | 缩进设置 | 中 | 待实现 |
| TAB | 制表符设置 | 中 | 待实现 |
| LINE | 行间距 | 低 | 待实现 |
| COLUMN | 列设置 | 低 | 待实现 |

#### 7. 高级输入处理 (Advanced Input)

| 命令 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| INPUTLIST | 列表选择输入 | 高 | 待实现 |
| INPUTMULTI | 多选输入 | 中 | 待实现 |
| INPUTCHAR | 字符输入 | 中 | 待实现 |
| INPUTDATE | 日期输入 | 低 | 待实现 |
| INPUTTIME | 时间输入 | 低 | 待实现 |

#### 8. 系统状态函数 (System Status)

| 函数 | 描述 | 优先级 | 状态 |
|------|------|--------|------|
| ISSKIP | 是否跳过 | 高 | 已实现 ✅ |
| ISSTOP | 是否停止 | 中 | 待实现 |
| ISANIME | 是否动画中 | 中 | 待实现 |
| ISMOUSE | 鼠标可用 | 中 | 待实现 |
| ISSOUND | 声音可用 | 中 | 待实现 |
| GETSCREEN | 获取屏幕信息 | 中 | 待实现 |

## 技术架构

### 1. 图形渲染层

需要实现的组件：
- **Sprite渲染器**: 处理图片绘制
- **形状绘制器**: 矩形、圆形、线条
- **颜色管理器**: RGB/HEX转换，颜色缓存
- **画笔系统**: 样式、粗细、填充

### 2. 音频系统

需要实现的组件：
- **音频引擎**: BGM/SE/VOICE管理
- **音量控制器**: 淡入淡出、音量调节
- **播放队列**: 多音频并发处理
- **资源管理器**: 音频文件加载和缓存

### 3. 窗口管理系统

需要实现的组件：
- **窗口管理器**: 多窗口支持
- **布局引擎**: 对齐、缩进、列控制
- **文本渲染器**: 样式化文本输出
- **输入处理器**: 鼠标/键盘事件分发

### 4. 鼠标输入系统

需要实现的组件：
- **事件监听器**: 鼠标点击、移动、悬停
- **坐标转换器**: 屏幕坐标 ↔ 逻辑坐标
- **状态管理器**: 按键状态、点击计数
- **模拟器**: 程序化鼠标操作

## 实现计划

### 阶段 1: 基础窗口和颜色 (Week 1)
- [ ] CLEARLINE, REUSELASTLINE
- [ ] RGB, RGBCOLOR, HEXCOLOR
- [ ] ALIGN
- [ ] GETBGCOLOR

### 阶段 2: 高级图形绘制 (Week 2)
- [ ] DRAWSPRITE (图片加载和渲染)
- [ ] DRAWRECT, FILLRECT
- [ ] DRAWCIRCLE
- [ ] SETBRUSH

### 阶段 3: 音频系统 (Week 3)
- [ ] PLAYBGM, STOPBGM
- [ ] PLAYSE, STOPSE
- [ ] VOLUME
- [ ] 音频资源管理

### 阶段 4: 鼠标输入 (Week 4)
- [ ] INPUTMOUSE
- [ ] MOUSEPOS
- [ ] MOUSESTATE
- [ ] 事件处理系统

### 阶段 5: 高级输入和系统函数 (Week 5)
- [ ] INPUTLIST
- [ ] INPUTMULTI
- [ ] ISSTOP, ISANIME
- [ ] 完整测试套件

## 测试计划

### 单元测试
- 图形渲染测试
- 音频播放测试
- 窗口管理测试
- 鼠标事件测试

### 集成测试
- 多媒体场景测试
- 窗口切换测试
- 输入流程测试

### 性能测试
- 图形渲染性能
- 音频延迟测试
- 内存使用监控

## 依赖和资源

### 外部依赖
- **Foundation**: 文件、日期、数据
- **AppKit**: 窗口、图形、事件
- **AVFoundation**: 音频播放
- **CoreGraphics**: 2D图形渲染

### 资源文件
- 图片格式支持: PNG, JPG, BMP
- 音频格式支持: MP3, WAV, OGG
- 字体支持: 系统字体、自定义字体

## 风险评估

### 技术风险
1. **音频延迟**: macOS音频系统可能有延迟
   - 缓解: 使用AVFoundation优化，预加载音频

2. **图形性能**: 大量精灵渲染可能卡顿
   - 缓解: 实现批处理渲染，纹理缓存

3. **事件冲突**: 鼠标和键盘事件冲突
   - 缓解: 事件优先级管理，状态机

### 时间风险
1. **音频系统复杂性**: 可能需要额外时间
2. **图形渲染优化**: 性能调优耗时
3. **测试覆盖**: 需要全面的测试用例

## 验收标准

### 功能完整性
- [ ] 所有Priority 4命令实现
- [ ] 所有Priority 4函数实现
- [ ] 错误处理和边界条件

### 测试覆盖率
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖主要场景
- [ ] 性能测试达标

### 代码质量
- [ ] 无编译警告
- [ ] 符合KISS原则
- [ ] 文档完整

## 预期成果

### 可运行功能
1. **多媒体演示**: 音乐+音效+图片的视觉小说场景
2. **交互演示**: 鼠标点击选择，窗口切换
3. **图形演示**: 绘制矩形、圆形、图片

### 文档产出
1. **API文档**: 所有新命令/函数的详细说明
2. **实现总结**: Phase 4实现总结文档
3. **示例代码**: 使用新功能的示例脚本

## 项目管理

### 里程碑
- **M1**: 基础窗口和颜色 (Week 1)
- **M2**: 图形绘制完成 (Week 2)
- **M3**: 音频系统完成 (Week 3)
- **M4**: 鼠标输入完成 (Week 4)
- **M5**: 全部测试通过 (Week 5)

### 每日工作
- 晨会: 昨日进度，今日计划
- 代码审查: 每个PR必须审查
- 测试驱动: 先写测试，后写代码

## 总结

Phase 4 是从核心引擎向完整游戏引擎迈进的关键一步。通过实现窗口管理、多媒体支持和高级交互，将使Emuera for macOS具备开发商业级视觉小说的能力。

**预计开发周期**: 5周
**优先级**: 高
**依赖**: Phase 3 完成
**目标**: 95% 功能完成度